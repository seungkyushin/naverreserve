<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="description" content="네이버 예약, 네이버 예약이 연동된 곳 어디서나 바로 예약하고, 네이버 예약 홈(나의예약)에서 모두 관리할 수 있습니다.">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <title>네이버 예약</title>
    <link href="../css/style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
</head>

<body>
    <div id="container">
        <div class="header">
            <header class="header_tit">
                <h1 class="logo">
                    <a href="./mainpage.html" class="lnk_logo" title="네이버"> <span class="spr_bi ico_n_logo">네이버</span> </a>
                    <a href="./myreservation.html" class="lnk_logo" title="예약"> <span class="spr_bi ico_bk_logo">예약</span> </a>
                </h1>
                <a href="./bookinglogin.html" class="btn_my"> <span class="viewReservation" title="예약확인">예약확인</span> </a>
            </header>
        </div>
        <hr>
        <div class="event">
            <div class="section_visual">
                <div class="group_visual">
                    <div class="container_visual">
                        <div class="prev_e" style="display:none;">
                            <div class="prev_inn">
                                <a href="#" class="btn_pre_e" title="이전"> <i class="spr_book_event spr_event_pre">이전</i> </a>
                            </div>
                        </div>
                        <div class="nxt_e" style="display:none;">
                            <div class="nxt_inn">
                                <a href="#" class="btn_nxt_e" title="다음"> <i class="spr_book_event spr_event_nxt">다음</i> </a>
                            </div>
                        </div>
                        <div>
                            <div class="container_visual">
                                <!-- [D] 이전,다음 버튼을 클릭할때마다 캐러셀 형태로 순환 됨 -->
                              
                                
                                <ul class="visual_img">
                                	  <!--  <li> <img src="##" class="promotion_img"></li>-->
                                </ul>
                        
                            </div>
                            <span class="nxt_fix" style="display:none;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section_event_tab">
                <ul class="event_tab_lst tab_lst_min">
                    <li class="item" data-category="0">
                        <a class="anchor active"> <span>전체리스트</span> </a>
                    </li>
                 
                </ul>
            </div>
            <div class="section_event_lst">
                <p class="event_lst_txt">바로 예매 가능한 행사가 <span class="pink">0개</span> 있습니다</p>
                <div class="wrap_event_box">
                    <!-- [D] lst_event_box 가 2컬럼으로 좌우로 나뉨, 더보기를 클릭할때마다 좌우 ul에 li가 추가됨 -->
                    <ul class="lst_event_box"><!--왼쪽 뮤지컬,영화 등등 정보 넣기 --></ul>
                    <ul class="lst_event_box"><!--오른쪽 뮤지컬,영화 등등 정보 넣기 --></ul>
                    <!-- 더보기 -->
                    <div class="more">
                        <button class="btn"><span>더보기</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="gototop">
            <a href="#" class="lnk_top"> <span class="lnk_top_text">TOP</span> </a>
        </div>
        <div class="footer">
            <p class="dsc_footer">네이버(주)는 통신판매의 당사자가 아니며, 상품의정보, 거래조건, 이용 및 환불 등과 관련한 의무와 책임은 각 회원에게 있습니다.</p>
            <span class="copyright">© NAVER Corp.</span>
        </div>
    </footer>





<script>


function myAjax(url,http,func){
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function(){
		 if (this.readyState == 4 && this.status == 200) {
			func(this);
		 }
		 
	}
	xhttp.open(url, http);
	xhttp.send();
}

function Init(){
	initPromotion();
	initCategory();
	initProduct();
	
	var moreBtn = document.querySelector(".btn");
	moreBtn.addEventListener('click',function(){
		ShowProductItems();
	});
	


}

function ShowProductItems(){
	var activeCategory = document.querySelector(".anchor.active");
	var courrentCategoryId = activeCategory.parentElement.dataset.category;
	var productElements = document.getElementsByClassName("lst_event_box");
	var productCount = 0;
	
	var moreBtn = document.querySelector(".btn");
	
	//< 현재 상품 리스트 개수 구하기
	for( var i = 0; i < 2; i++)
		productCount += productElements[i].children.length;
	
	//< 최개 개수랑 현재 개수랑 같으면 더보기 버튼을 숨기고 서버에 요청하지 않는다.
	 var productCountElement = document.querySelector(".event_lst_txt");
	if( productCount+'개' ==  productCountElement.children[0].innerHTML)		{
		
			moreBtn.hidden = true;
		}
	else{
		moreBtn.hidden = false;
		var url = "http://localhost:8080/naverreserve/api/products?categoryId="+ courrentCategoryId +"&start=" + productCount;
		console.log(url);
		myAjax("GET",url,setProductItem);
	}
			

}
function initCategory(){
	
	myAjax("GET","http://localhost:8080/naverreserve/api/categories",categoryName);

	var categoryElements = document.querySelector(".event_tab_lst");
	categoryClicked(categoryElements);
	
}
function initPromotion(){
	myAjax("GET","http://localhost:8080/naverreserve/api/promotions",setPromotionsTemp);
}
function setPromotionsTemp(response)
{
	var responseData = JSON.parse(response.responseText);
	var PromotionElements = document.querySelector(".visual_img");
	
	var promotionItem = document.querySelector("#promotionItem");
	var parser = Handlebars.compile(promotionItem.innerText);
	
	var testHTML = "";
	responseData.items.forEach(function(e){
		var data = {
				imageSrc : "/naverreserve/" + e.imageSrc,
				tit : "",
				adr : "",
				dsc : ""
			};
			
			var resultHTML = parser(data);
			testHTML += resultHTML;
			PromotionElements.innerHTML += resultHTML;
	});

	 var count = 0;
	var animationfunc = setInterval(function(){
			var test = PromotionElements.children[count];
			
			var widthSize = test.offsetWidth;
			if(count != 0)
				PromotionElements.children[count-1].style.cssText += "display:none";
			test.style.transform +="translateX(-" + widthSize +"px)";
		 	count++;
		 	if( PromotionElements.childElementCount-1 < count)
		 		{
		 			count = 0;
		 		}
		 	
		 	if(count == 5)
		 		{
		 			//PromotionElements.children[0].style.cssText += "display:none";
		 			PromotionElements.children[0].style.transform ="";
		 		}
		
	  },2000);   


}


function setPromotions(response){
	var responseData = JSON.parse(response.responseText);
	var dataSize = responseData.size;
	var PromotionElements = document.querySelector(".visual_img");
	
	var arrayPromotionSrc = [];
	
	//< Ajax로 데이터를 받아와 hmml 수정
	for(var index = 0; index < dataSize; index++)
		{
			var html = '<li><img src="/naverreserve/img/' +
			responseData.items[index].productId 
			+ '_ma_'
			+ responseData.items[index].productImageId
			+ '.png" class="promotion_img"></li>';
			
			//< html에 Element를 정적으로 만들어 놓지 않으면 DOM조작시 CSS옵션이 잘 먹지않아
			//< 이코드는 정적으로 Element를 만들어놓고 다시 동적으로 생성하였다.
			if(index == 0)
			{
				PromotionElements.innerHTML = html;
			}				
			else if( index < 3)
				PromotionElements.innerHTML += html;

			var tempSrc = '<img src="/naverreserve/img/' +
			responseData.items[index].productId 
			+ '_ma_'
			+ responseData.items[index].productImageId
			+ '.png" class="promotion_img">';
			arrayPromotionSrc[index] = html;
		}
	
	
	  var promotionImg = document.getElementsByClassName("promotion_img");
	  var isanimation = false;
	  var move = 414;
	  var showIndexMax = 3;
	  var promotionImgIndex = 0;
	  var animationfunc = setInterval(function(){
			 
		  if( isanimation )
		  {
			  var tempsrc = arrayPromotionSrc[0];
			  arrayPromotionSrc.shift();
			  arrayPromotionSrc.push(tempsrc);
			  
			  var showImageSrc="";
			  for( var index = 0; index < showIndexMax; index++ )
			  {
				  showImageSrc += arrayPromotionSrc[index];
			  }
			  
			  PromotionElements.innerHTML = showImageSrc;
			  isanimation = false;
		  }
		  else
			  {
			 	 for( var index = 0; index < showIndexMax; index++ )
			 	 {
			  		promotionImg[index].style.transform += "translateX(-"+ move +"px)";
		 	 	 }
			  	isanimation = true;
			  }
	  },1000);  
	
}
function initProduct(){
	myAjax("GET","http://localhost:8080/naverreserve/api/products",setProductItem);
}
function setProductItem(response){
	
	var responseData = JSON.parse(response.responseText);
	var ProductPreviewParent = document.getElementsByClassName("lst_event_box");


	var templateList = document.querySelector("#itemList");
	var parser = Handlebars.compile(templateList.innerText);
	
	 for(var i = 0; i < responseData.totalCount; i++)
	 {
		 
			var data = {
					displayInfoId :responseData.productsList[i].productId,
					description : responseData.productsList[i].description,
					imgPath : responseData.productsList[i].imageSrc,
					placeName : responseData.productsList[i].placeName,
					content : responseData.productsList[i].content,
					};

			
			 var resultHTML = parser(data);
		 ProductPreviewParent[i%2].innerHTML += resultHTML;
	 }
	
}

// 카테고리 별 이름 설정
function categoryName(response){
	var responseData = JSON.parse(response.responseText);
	var dataSize = responseData.size;
	var categoryElements = document.querySelector(".event_tab_lst");
	 
	//< 카테고리 별로 상품 개수 구하기
	categoryCount(response);
	
	var template = document.querySelector("#categoryList");
	var parser = Handlebars.compile(template.innerHTML);
	var data = {};
	
	for(var index = 0; index < dataSize; index++ )
		{
			data = {
					id : responseData.items[index].id,
					name : responseData.items[index].name
			}; 
		
			 var html = parser(data);
							 
			 categoryElements.innerHTML += html;
		}
}

//< 카테고리 개수 구하기 
function categoryCount(response){
	var responseData = JSON.parse(response.responseText);
	var productCountElement = document.querySelector(".event_lst_txt");
	var activeCategory = document.querySelector(".anchor.active");
	var courrentCategoryId = activeCategory.parentElement.dataset.category;
	var viewCount = 0;
	
	//< courrentCategoryId 0은 전체 
	 if( courrentCategoryId == 0)
	 {
		 for(var i =0 ;i < responseData.size; i++)
			 {
			 	viewCount += responseData.items[i].count;
			 }
		 
	 }else
	 {
		 viewCount = responseData.items[courrentCategoryId-1].count
	 }
	
 	 var html =  viewCount + '개';
	 productCountElement.firstElementChild.innerHTML = html;
	
}


function categoryClicked(Element){
	Element.addEventListener("click",function(e){

		var Targettext = event.target.innerText;
		var childCount = Element.childElementCount;
		var click = 0;
		var clickedName = [];
	 
		if( Targettext.length > 5 ) return; 
		
		for(var i = 0; i < childCount; i++)
			{	
				clickedName = Element.children[i].firstElementChild.firstElementChild.innerText;
				
				if( clickedName == Targettext )
					Element.children[i].firstElementChild.className = "anchor active";
				else
					Element.children[i].firstElementChild.className = "anchor";
			
			}
	
		
		//< product HTML 초기화
		 var ProductPreviewParent = document.getElementsByClassName("lst_event_box");
		 ProductPreviewParent[0].innerHTML = "";
	 	 ProductPreviewParent[1].innerHTML = "";
	 	 ShowProductItems();
	 	 
	 	myAjax("GET","http://localhost:8080/naverreserve/api/categories",categoryCount);
	 	 
	});
}
window.addEventListener('DOMContentLoaded', function () {
	Init();
});

</script> 


    <script type="rv-template" id="promotionItem">
    <li class="item promotion_img" style="width:100%;background-image: url({{imageSrc}});">
        <a href="#"> <span class="img_btm_border">{{btm_border}}</span> <span class="img_right_border">{{right_border}}</span> <span class="img_bg_gra">{{bg_gra}}</span>
            <div class="event_txt">
                <h4 class="event_txt_tit">{{tit}}</h4>
                <p class="event_txt_adr">{{adr}}</p>
                <p class="event_txt_dsc">{{dsc}}</p>
            </div>
        </a>
    </li>
    </script>

<script type="rv-template" id="categoryList">
<li class="item" data-category="{{id}}">
	<a class="anchor">
		 <span>{{name}}</span> 
	</a>
</li>
</script>

    <script type="rv-template" id="itemList">
        <li class="item">
            <a href="detail.html?displayInfoId={{displayInfoId}}" class="item_book">
                <div class="item_preview">
                    <img alt="{{description}}" class="img_thumb" src="{{imgPath}}">
                    <span class="img_border"></span>
                </div>
                <div class="event_txt">
                    <h4 class="event_txt_tit"> <span>{{description}}</span> <small class="sm">{{placeName}}</small> </h4>
                    <p class="event_txt_dsc">{{content}}</p>
                </div>
            </a>
        </li>
    </script>
</body>

</html>
